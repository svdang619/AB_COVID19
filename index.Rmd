---
title: "Alberta COVID19 Dashboard"
author: "Steven Dang"
date: "Last updated on 28 October 2021"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
    storyboard: yes
    theme: flatly
    vertical_layout: fill

---
```{r Global setup, include=FALSE}
library(colourpicker)
library(crosstalk)
library(DT)
library(dygraphs)
library(flexdashboard)
library(fontawesome)
library(geojsonio)
library(geojsonR)
library(httr)
library(htmltools)
library(jsonlite)
library(leaflet.extras)
library(leaflet)
library(lubridate)
library(mapview)
library(plotly)
library(reshape2)
library(sf)
library(tidyverse)
library(zoo)



`%notin%` <- Negate(`%in%`)

#COVID-19 Cases https://www.alberta.ca/stats/covid-19-alberta-statistics.htm#data-export

COVID19_get <- GET("https://data.edmonton.ca/resource/jmcu-tz8y.json?$limit=1000000")
COVID19 <- fromJSON(rawToChar(COVID19_get$content))

COVID19 <- COVID19 %>% select(-index)
names(COVID19) <- c("Date_reported", "AHS_Zones", "Gender", "Age_Group", "Case_Status", "Case_Type")
COVID19$Date_reported <- as_date(COVID19$Date_reported)

#-------------------------------------------------------------------------------------------------------

 #https://data.edmonton.ca/Community-Services/COVID-19-in-Alberta-Current-cases-by-local-geograp/ix8f-s9xp


Vaccine_get <- GET("https://data.edmonton.ca/resource/ix8f-s9xp.json?$limit=200")
Vaccine <- fromJSON(rawToChar(Vaccine_get$content))


Vaccine$date <- as_date(Vaccine$date)

Vaccine <- Vaccine %>% mutate_at(c("population",
                                   "total_cases", 
                                   "active_cases", 
                                   "recovered_cases",
                                   "deaths",
                                   "dose_1",
                                   "dose_2",
                                   "total_doses_administered",
                                   "percent_pop_1_plus_dose",
                                   "percent_pop_fully_immunized"), as.numeric)


#--------------------------------------------------------------------------------------------------------

#Vaccine # per age group per location #https://data.edmonton.ca/Externally-Sourced-Datasets/COVID-19-in-Alberta-Vaccination-Progress-by-Local-/tgzq-jumt


Vaccine_ages_get <- GET("https://data.edmonton.ca/resource/tgzq-jumt.json?$limit=100000")
Vaccine_ages <- fromJSON(rawToChar(Vaccine_ages_get$content))

Vaccine_ages$date <- as_date(Vaccine_ages$date)

Vaccine_ages <- Vaccine_ages %>% mutate_at(c("population", 
                                             "dose_1", 
                                             "dose_2", 
                                             "total_doses_administered", 
                                             "percent_pop_1_plus_dose",
                                             "percent_pop_fully_immunized"), as.numeric)




#---------------------------------------------------------------------------------------------------------

#Total Alberta Vaccine #'s overtime https://data.edmonton.ca/Externally-Sourced-Datasets/COVID-19-in-Alberta-Vaccination-Progress-by-Zone/d43f-8ikp


Vaccine_Progress_get <- GET("https://data.edmonton.ca/resource/d43f-8ikp.json?$limit=1000")
Vaccine_Progress <- fromJSON(rawToChar(Vaccine_Progress_get$content))

Vaccine_Progress$date <- as_date(Vaccine_Progress$date)

Vaccine_Progress <- Vaccine_Progress %>% mutate_at(c("population", 
                                                     "dose_1", 
                                                     "dose_2", 
                                                     "total_doses_administered",
                                                     "percent_pop_1_plus_dose",
                                                     "percent_pop_fully_immunized"), as.numeric)


#-----------------------------------------------------------------------------------------------------------

#Hospitalization Rates https://data.edmonton.ca/Community-Services/COVID-19-in-Alberta-Day-by-day/gxqm-z6fa

Hospital_get <- GET("https://data.edmonton.ca/resource/gxqm-z6fa.json?$limit=10000")
Hospital <- fromJSON(rawToChar(Hospital_get$content))

names(Hospital) <- c("Date", 
                     "Location", 
                     "Confirmed_Cases",
                     "Active_Cases",
                     "Recovered",
                     "In_hospital", 
                     "ICU", 
                     "Deaths", 
                     "Tests",
                     "Rate_Cases",
                     "Test_pos_rate")

Hospital$Date <- as_date(Hospital$Date)

Hospital <- Hospital %>% mutate_at(c("Confirmed_Cases", 
                                     "Tests",
                                     "Test_pos_rate",
                                     "Active_Cases", 
                                     "Recovered", 
                                     "In_hospital", 
                                     "ICU", 
                                     "Deaths", 
                                     "Rate_Cases"), as.numeric)



                    
#---------------------------------------------------------------------------------------------------------

#Historical Case count for AB Zones - This is not put in use. This is meant to help create an animated choropleth on the
# introduction page but i am unable to do it for now. The plot is created using Vaccine dataset.
#https://data.edmonton.ca/Externally-Sourced-Datasets/COVID-19-in-Alberta-Case-History-by-Municipality-a/rrjc-ssaw
#set limit 84000

Historical_get <- GET("https://data.edmonton.ca/resource/rrjc-ssaw.json?$limit=2000")

Historical <- fromJSON(rawToChar(Historical_get$content))

Historical$date <- as_date(Historical$date)

Historical$cases_total <- as.numeric(Historical$cases_total)





Historical_SHP_get <- geojson_read("https://data.edmonton.ca/resource/rrjc-ssaw.geojson?$limit=2000", what = "sp")






```


```{r, include = TRUE}
#Allow the use of fontawesome icons since rmarkdown is not updated to use the new icons
htmltools::tagList(fontawesome::fa_html_dependency())


```



Introduction 
===========================================================================

Row {data-width = 200}
---------------------------------------------------------------------------

### Daily Count

```{r Daily Case Count}
case_count <- COVID19 %>% group_by(Date_reported) %>% count()
case_count$Diff <- case_count$n - lag(case_count$n)

valueBox(value = prettyNum(last(case_count$n), big.mark = ","), 
         caption = paste0("Daily Case Count", "<br>", "Change: ",  prettyNum(last(case_count$Diff), big.mark = ",")), 
         color = "blue", 
         icon = "fas fa-biohazard")

```

### Active Cases

```{r Active Cases}

Active_cases_valuebox <- Hospital %>% filter(Location == "Alberta") %>% group_by(Date) %>% select(Active_Cases) %>% arrange(Date)

Active_cases_valuebox$Diff <-Active_cases_valuebox$Active_Cases - lag(Active_cases_valuebox$Active_Cases)

valueBox(value = prettyNum(last(Active_cases_valuebox$Active_Cases), big.mark = ","), 
         caption = paste0("Active Cases", "<br>", "Change: ", last(Active_cases_valuebox$Diff)), 
         color = "teal", 
         icon = "fas fa-chart-bar")
```

### Total Deaths

```{r Total Deaths}
Deaths <- Hospital %>% filter(Location == "Alberta")  %>% select(Date, Deaths) %>% arrange(Date)



Deaths$Diff <- Deaths$Deaths - lag(Deaths$Deaths)

valueBox(value = prettyNum(last(Deaths$Deaths), big.mark = ","), 
         caption = paste0("Total Death Count", "<br>", "Change: ", prettyNum(last(Deaths$Diff), big.mark = ",")),
         color = "red",
         icon = "fas fa-skull-crossbones")

```

### Total Vaccine Doses administered

```{r Total Vaccine Doses Administered}


AB_Total_Vacc <- Vaccine_Progress %>% group_by(date) %>% summarise(Total_Vacc = sum(total_doses_administered))

AB_Total_Vacc$Diff <- AB_Total_Vacc$Total_Vacc - lag(AB_Total_Vacc$Total_Vacc)

valueBox(value = prettyNum(last(AB_Total_Vacc$Total_Vacc), big.mark = ","), 
         caption = paste0("Total Doses Administered", "<br>", "Change: ", prettyNum(last(AB_Total_Vacc$Diff), big.mark = 
                                                                                      ",")),
         color = "fuchsia",
         icon = "fas fa-syringe")
```

### Lab Positivity Rate
```{r  Lab Positivity Rate}

Lab_Pos <- Hospital %>% group_by(Date) %>% na.omit() %>% summarise(pos_rate = sum(Test_pos_rate/n()))
Lab_Pos$Diff <- Lab_Pos$pos_rate - lag(Lab_Pos$pos_rate)

valueBox(value = prettyNum(last(Lab_Pos$pos_rate)), 
         caption = paste0("Positivity Rate (%)", "<br>", "Change: ", prettyNum(last(Lab_Pos$Diff)), "%"),  
         color = "green",
         icon = "fas fa-vial")
```

### Hospitalization Number
```{r Hospitalization Number}
Hosp_num <- Hospital %>% group_by(Date) %>% na.omit() %>% summarise(Hosp = sum(In_hospital))
Hosp_num$Diff <- Hosp_num$Hosp - lag(Hosp_num$Hosp)

valueBox(value = prettyNum(last(Hosp_num$Hosp), big.mark = ","), 
         caption = paste0("Hospitalizations", "<br>", "Change: ", prettyNum(last(Hosp_num$Diff), big.mark = ","), "<br>",
                          "Record High: ", prettyNum(max(Hosp_num$Hosp), big.mark = ",")),
         color = "orange",
         icon = "fas fa-hospital")
```

### ICU Number
```{r ICU Number}
ICU_num <- Hospital %>% group_by(Date) %>% na.omit() %>% summarise(ICU_case = sum(ICU))
ICU_num$Diff <- ICU_num$ICU_case - lag(ICU_num$ICU_case)

valueBox(value = prettyNum(last(ICU_num$ICU_case), big.mark = ","), 
         caption = paste0("Patients in ICU", "<br>", "Change: ", prettyNum(last(ICU_num$Diff), big.mark = ","), "<br>",
                          "Record High: ", prettyNum(max(ICU_num$ICU_case), big.mark = ",")),
         color = "olive",
         icon = "fas fa-procedures")
         
```






Row {data-width = 600}
---------------------------------------------------------------------------------
```{r Active Cases geojson}
#leaflet_geojson <- readr::read_file("https://data.edmonton.ca/resource/ix8f-s9xp.geojson")
#Data from https://data.edmonton.ca/Community-Services/COVID-19-in-Alberta-Current-cases-by-local-geograp/ix8f-s9xp

leaflet_geojson <- geojsonio::geojson_read("https://data.edmonton.ca/resource/ix8f-s9xp.geojson", what = "sp")
leaflet_geojson_date <- leaflet_geojson$date
```

### Alberta Active Cases as of `r max(leaflet_geojson_date)`
```{r eval = TRUE}


numeric <- as.numeric(leaflet_geojson$active_cases)
colbins <- c(0,50,100,150,200,300,400)
col <- colorBin("Greens", domain = as.numeric(leaflet_geojson$active_cases), bins = colbins)


leaflet(leaflet_geojson) %>% addProviderTiles("Esri")%>% setView(lng = -115, lat = 55, zoom = 5) %>% 
  setMaxBounds(lng1 = -120, lng2 = -110, lat1 = 52, lat2 = 57) %>% 
  
  addPolygons( fillOpacity = 0.5,
               weight = 0.7,
               color = "green", 
               fillColor = ~col(as.numeric(leaflet_geojson$active_cases)),
               popup = ~paste("<b>", "Location: ", "</b>", location, "<br>",
                              "<b>", "Date: ", "</b>", date, "<br>", 
                              "<b>", "Active Cases: " , "</b>", active_cases), 
               highlight = highlightOptions(weight = 5, 
                                            color = "black", 
                                            bringToFront = TRUE)) %>% 
  
  addLegend(pal = col, 
            values = leaflet_geojson$active_cases, 
            position = "bottomright",
            title = "Active Cases")
  
```


### Chart 2 Animated graph of total cases in Alberta by zone
```{r eval = TRUE}
COVID19_Week <- COVID19 %>% mutate(Week = format(Date_reported, "%Y-%U")) %>% arrange(Week)


COVID19_Week<- COVID19_Week %>% count(Week, AHS_Zones) %>% complete(Week, AHS_Zones, fill = list(n = 0))

cumulative_COVID19_Week <- COVID19_Week %>% split(f = .$Week) %>% accumulate(., ~bind_rows(.x,.y)) %>% bind_rows(.id = "frame")

cumulative_COVID19_Week %>% plot_ly(x = ~Week, y = ~n, color = ~AHS_Zones) %>% 
  add_lines(frame = ~frame, ids = ~AHS_Zones) %>% 
  animation_opts(frame = 300) %>% 
  layout(xaxis = list(title = "Date in weeks", autoscale = TRUE),
         yaxis = list(title = "Case Counts", autoscale = TRUE))

#Change hover info to year-month-week and cases:
#autoplay x  times


```


Column {data-width = 100}
------------------------------------------------------------------------------
```{r}
zone_fully_imm <- Vaccine_Progress %>% group_by(location) %>% filter(date == max(date))
```


### Calgary Zone
```{r}
gauge(value = round(zone_fully_imm$percent_pop_fully_immunized[1],1), min = 0, max = 100, symbol = "%", label = "Two doses", gaugeSectors(success = c(70,100), danger = c(40,69), warning = c(0,39)))
```

### Central Zone
```{r}
gauge(value = round(zone_fully_imm$percent_pop_fully_immunized[2],1), min = 0, max = 100, symbol = "%", label = "Two doses", gaugeSectors(success = c(70,100), danger = c(40,69), warning = c(0,39)))
```

### Edmonton Zone
```{r}
gauge(value = round(zone_fully_imm$percent_pop_fully_immunized[3],1), min = 0, max = 100, symbol = "%", label = "Two doses", gaugeSectors(success = c(70,100), danger = c(40,69), warning = c(0,39)))
```

### Total AB Population
```{r}


gauge(value = round(sum(zone_fully_imm$dose_1)/sum(zone_fully_imm$population)*100,1), min = 0, max = 100, symbol = "%", label = "One dose", gaugeSectors(success = c(70,100), danger = c(40,69), warning = c(0,39)))
```

### North Zone
```{r}
gauge(value = round(zone_fully_imm$percent_pop_fully_immunized[4],1), min = 0, max = 100, symbol = "%", label = "Two doses", gaugeSectors(success = c(70,100), danger = c(40,69), warning = c(0,39)))
```

### South Zone

```{r}
gauge(value = round(zone_fully_imm$percent_pop_fully_immunized[5],1), min = 0, max = 100, symbol = "%", label = "Two doses", gaugeSectors(success = c(70,100), danger = c(40,69), warning = c(0,39)))
```

### Total AB Population
```{r}
gauge(value = round(sum(zone_fully_imm$dose_2)/sum(zone_fully_imm$population)*100, 1), min = 0, max = 100, symbol = "%", label = "Two doses", gaugeSectors(success = c(70,100), danger = c(40,69), warning = c(0,39)))
```


Cases
=============================================================================




Row
------------------------------------------------------------------------------

### COVID-19 Cases in Alberta by day and case status
```{r eval = TRUE}


Cases_Chart1 <- Hospital %>% group_by(Date) %>% select(-Tests:-Test_pos_rate, -In_hospital:-ICU) %>% summarise(Total = sum(Confirmed_Cases), Active_sum = sum(Active_Cases), Recovered_sum = sum(Recovered), Deaths_sum = sum(Deaths)) %>% na.omit()

Cases_Chart1$Date <- as.Date(Cases_Chart1$Date)

Chart1 <-  Cases_Chart1 %>% plot_ly(x = ~Date, y = ~Total, name = "Total", type = "scatter", mode = "line", line = list(color = 'rgb(2,1,3)', width = 2))

Chart1 <- Chart1 %>% add_trace(y = ~Active_sum, name = "Active", line = list(color = 'rgb(22,96,167)', width = 2))
Chart1 <- Chart1 %>% add_trace(y = ~Recovered_sum, name = "Recovered", line = list(color = 'rgb(22,167,46)', width = 2))
Chart1 <- Chart1 %>% add_trace(y = ~Deaths_sum, name = "Deaths", line = list(color = 'rgb(205,12,24)', width = 2))

Chart1 <- Chart1 %>% layout(title = "COVID-19 in Alberta",
                            xaxis = list(title = "Date", tickangle = 45),
                            yaxis = list(title = "COVID-19 Cases (n)"))


Chart1



```




### Active Cases by age as of `r max(as_date(Hospital$Date, format = "%B %d, %Y"))`

```{r eval = TRUE}

active_by_age <- COVID19 %>% filter(Case_Status == "Active") %>% group_by(Age_Group) %>% select(Date_reported, Age_Group, Gender) %>% summarise(Active_COVID19_Cases = n())


active_by_age %>% 
  plot_ly(x = ~Age_Group, y = ~Active_COVID19_Cases) %>% 
  add_bars() %>%
  layout(title = "Active Cases",
         xaxis = list(title = ""),
         yaxis = list(title = "COVID-19 Cases (n)"))


```



Row
-------------------------------------------------------------------------------
### COVID-19 by gender and age group
```{r eval = TRUE}

                    
Case_by_Age_Gender <- COVID19 %>% group_by(Gender, Age_Group) %>% summarise(total = n()) %>% filter(Gender %notin% "Unknown")


Chart3 <- ggplot(Case_by_Age_Gender, aes(x = Age_Group, y = total, fill = Gender)) + 
  geom_col(show.legend = FALSE) + 
  facet_wrap(~Gender) + 
  theme_classic() + 
  scale_y_continuous(expand = expansion(mult=c(0,.1))) + 
  xlab("Age Group") + 
  ylab("Count") + 
  ggtitle("Number of COVID-19 cases in Alberta by age group facetted by gender") + 
  theme(axis.title.x = element_text(margin = margin(-5,0,0,0))) + 
  theme(legend.position = "none") + 
  theme(axis.text.x = element_text(angle = 45)) + 
  theme(axis.title.x = element_blank())
                                                                                                                                                                                                                                                                                                                                                                                                                                              
ggplotly(Chart3)





```


### Active Cases by zone as of `r max(as_date(Hospital$Date, format = "%B %d, %Y"))`
```{r eval = TRUE}

Active <- Hospital %>% filter(Date == max(Date), Location %notin% "Alberta") %>% group_by(Location)



Active <- Active %>% ggplot(aes(x = Location, y = Active_Cases, fill = Location)) + geom_col() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5)) +
  scale_y_continuous(expand = expansion(mult=c(0,.1))) + 
  ylab("COVID-19 Cases (n)") + 
  ggtitle("Active Cases") +
  
  theme(axis.title.x = element_blank(),
        axis.ticks = element_blank()) +
  
  theme(axis.line = element_line(color = "black",
                                 size = 0.5,
                                 linetype = "solid")) +
  
  theme(panel.grid.major.x = element_blank()) +
  theme(panel.grid.major.y = element_line(size = .005, 
                                          color = 'gray')) +
  
  theme(panel.background = element_blank()) +
  theme(legend.position = "none")
  
  
  
ggplotly(Active)



```



Vaccine {.storyboard}
=============================================================================

### Choropleth map of Vaccinations in Alberta: last updated `r max(as_date(Vaccine$date, format = "%d%b%Y"))`
```{r}

Vacc_poly <- geojsonio::geojson_read("https://data.edmonton.ca/resource/ix8f-s9xp.geojson", what = "sp")

Vacc_poly@data <- Vacc_poly@data %>% mutate_at(c("population",
                                   "total_cases", 
                                   "active_cases", 
                                   "recovered_cases",
                                   "deaths",
                                   "dose_1",
                                   "dose_2",
                                   "total_doses_administered",
                                   "percent_pop_1_plus_dose",
                                   "percent_pop_fully_immunized"), as.numeric)

#Set parameters
colbins <- c(0,20,40,60,80,100)
vacc1_col_bins <- colorBin("OrRd", domain = Vacc_poly@data$percent_pop_1_plus_dose, bins = colbins, pretty = TRUE)
vacc2_col_bins <- colorBin("OrRd", domain = Vacc_poly@data$percent_pop_fully_immunized, bins = 6)



leaflet(Vacc_poly) %>% addProviderTiles("Esri")%>% setView(lng = -115, lat = 55, zoom = 5) %>% 
  setMaxBounds(lng1 = -120, lng2 = -110, lat1 = 52, lat2 = 57) %>% 
  
  addPolygons(weight = 1,
              color = "red",
              fillColor = ~vacc1_col_bins(percent_pop_1_plus_dose),
              fillOpacity = 0.5,
              popup = ~paste("Name:", location, "<br>",
                             "Population:", population, "<br>",
                             "Total Cases:", total_cases,"<br>",
                             "Active Cases:", active_cases, "<br>",
                             "Total Deaths:", deaths, "<br>",
                             "Total Dose Administered:", total_doses_administered, "<br>",
                             "% pop with 1 dose:", percent_pop_1_plus_dose, "<br>",
                             "% pop fully immunized:", percent_pop_fully_immunized),
              highlight = highlightOptions(weight =6, color = "black", bringToFront = TRUE),
              group = "At least one dose") %>%
  
  addPolygons(weight = 1,
              color = "red",
              fillColor = ~vacc2_col_bins(percent_pop_fully_immunized),
              fillOpacity = 0.5,
              popup = ~paste("Name:", location, "<br>",
                             "Population:", population, "<br>",
                             "Total Cases:", total_cases,"<br>",
                             "Active Cases:", active_cases, "<br>",
                             "Total Deaths:", deaths, "<br>",
                             "Total Dose Administered:", total_doses_administered, "<br>",
                             "% pop with 1 dose:", percent_pop_1_plus_dose, "<br>",
                             "% pop fully immunized:", percent_pop_fully_immunized),
              highlight = highlightOptions(weight =6, color = "black", bringToFront = TRUE),
              group = "Fully vaccinated") %>%
  
  
  addLegend(pal = vacc1_col_bins,
            values = Vacc_poly@data$percent_pop_1_plus_dose,
            position = "bottomright",
            title = "Percent %") %>%
  
  addLayersControl(baseGroups  = c("At least one dose", "Fully vaccinated "),
                   options = layersControlOptions(collapsed = TRUE))

  


```



### Total Doses Administered: last updated  `r max(as_date(Vaccine_Progress$date, format = "%d%b%Y"))`

```{r}
Vaccine_Progress_cum <- Vaccine_Progress %>% group_by(date) %>% summarise(dose1 = sum(dose_1), dose2 = sum(dose_2), total = sum(total_doses_administered))

Vaccine_Progress_cum %>% plot_ly(x = ~date, y = ~total) %>% add_lines()


```

### Vaccine Coverage

```{r eval = TRUE}
library(xts)

Vaccine_Progress$date <- as.Date(Vaccine_Progress$date)
Vaccine_coverage_xts <- Vaccine_Progress %>% group_by(date) %>% summarise(Dose1 = mean(percent_pop_1_plus_dose), Dose2 = mean(percent_pop_fully_immunized))
Vaccine_coverage_xts <- as.xts(Vaccine_coverage_xts[,-1], order.by = Vaccine_coverage_xts$date)
Vaccine_coverage_xts <- na.approx(Vaccine_coverage_xts)


dygraph(Vaccine_coverage_xts, main = "Vaccine Coverage") %>%
  dyAxis("x", drawGrid = FALSE) %>%
  dyAxis("y", drawGrid =  TRUE, label = "Vaccine Coverage (%)") %>%
  dySeries("Dose1", label = "1 Dose") %>%
  dySeries("Dose2", label = "2 Doses") %>%
  dyRangeSelector()


```


### Vaccine Coverage from `r min(as_date(Vaccine_Progress$date, format = "%d%b%Y"))` to `r max(as_date(Vaccine_Progress$date, format = "%d%b%Y"))`
```{r}


Vaccine_cum <- Vaccine_Progress %>% 
  group_by(date) %>% 
  select(date, dose_1, dose_2, population)%>% 
  summarise_all(sum) %>% 
  mutate(percent_1_dose = round(dose_1/population*100,2), percent_2_dose = round(dose_2/population * 100,2)) %>% 
  complete(date = seq.Date(min(date), max(date), by = "day"))


Vaccine_cum <- as.xts(Vaccine_cum[,-1], order.by = Vaccine_cum$date)
Vaccine_cum <- na.approx(Vaccine_cum) #Fill in date gaps (usually over the weekend/holidays)


Vaccine_cum_plot <- plot_ly(data = data.frame(date = index(Vaccine_cum), percent_1 = Vaccine_cum[,4,drop=T]),
                            x = ~date,
                            y = ~percent_1,
                            type = "bar",
                            name = "At least one dose")

Vaccine_cum_plot <- Vaccine_cum_plot %>% 
  add_trace(data = data.frame(date = index(Vaccine_cum), percent_2 = Vaccine_cum[,5,drop=T]),
                                                   x = ~date,
                                                   y = ~percent_2,
                                                   type = "bar",
                                                   name = "Fully Vaccinated")

Vaccine_cum_plot <- Vaccine_cum_plot %>% layout(xaxis = list(title = "Date"),
                                                yaxis = list(title = "Vaccine Coverage (%)"),
                                                title = "Vaccine Coverage in Alberta")
                            

Vaccine_cum_plot
```






```{r eval = FALSE}
### Test
dropdown(
  sliderInput("datesel", "Click to watch",
            min = min(Historical_SHP_get$date),
            max = max(Historical_SHP_get$date),
            value = min(Historical_SHP_get$date),
            step = 1,
            timeFormat = "%d %b %y",
            animate = animationOptions(interval = 300, loop = FALSE)),
  style = "unite", icon = icon("gear"),
  status = "danger", width = "200px",
  animate = animateOptions(
      enter = animations$fading_entrances$fadeInLeftBig,
      exit = animations$fading_exits$fadeOutRightBig)
  
)

#Selected data
selectedData <- Historical[Historical$date == "2020-03-20",]

#Match cases to spatial data
Historical_SHP_get$cases_active <- selectedData$cases_active[match(Historical_SHP_get$location, selectedData$location)]


#Create label texts
Historical_SHP_get@data$Labeltext <- paste0(
  "<b> Location: </b>", Historical_SHP_get@data$location,
  "<b> Cases: </b>", format(Historical_SHP_get@data$cases_active, nsmall = 0, big.mark = ",")
)


#Define Color Palettes
paletteBins <- c(0,10,20,30,40,50,60,70,80,100,200)
colorPalette <- colorBin(palette = "YloBr", domain = Historical$cases_active, na.color = "transparent", bins = paletteBins)



#Filter data depending on selected date
filteredData <- reactive({
  req(input$datesel)
  Historical_SHP_get[Historical_SHP_get$date == input$datesel,]
})


#Create the base leaflet map

map <- leaflet(Historical_SHP_get) %>% addProviderTiles("Esri")%>% setView(lng = -115, lat = 55, zoom = 5) %>% 
  setMaxBounds(lng1 = -120, lng2 = -110, lat1 = 52, lat2 = 57) %>%
  addPolygons(
    
    fillColor = "lightgray",
    stroke = TRUE,
    fillOpacity = 1,
    color = "white",
    weight = 1
  ) %>%
  
  leaflet::addLegend(pal = colorPalette, values = Historical$cases_active, opacity = 0.9, title = "Cases", position = "bottomright")





#Prepare data based on selected date


observe({
  
  Historical_SHP_get$cases_active <- filteredData()$cases_active[match(Historical_SHP_get$location, filteredData()$cases_active)]
  
  Historical_SHP_get@data$Labeltext <- paste0(
  "<b> Location: </b>", Historical_SHP_get@data$location,
  "<b> Cases: </b>", format(Historical_SHP_get@data$cases_active, nsmall = 0, big.mark = ","))

  
  
  leafletProxy(map,data = Historical_SHP_get) %>%
    clearMarkers()%>%
    setShapeStyle(layerID = ~location, fillcolor = ~ifelse(cases_active >= 0, colorPalette(cases_active), "lightgray"), label = Historical_SHP_get$Labeltext)
  
  
})





  
  
  





#Historical_SHP_get$cases_active <- filteredData()






```

Testing
============================================================

Row
-------------------------------------------------------------


### Lab Positivity Rate in Alberta

```{r eval = TRUE}


#Disclaimer: Absence of data for "Unknown" interferes with calculations and will be removed

# Positivity Rate

Pos_Rate <- Hospital %>% filter(Location %notin% "Unknown") %>% na.omit() %>% group_by(Date) %>% summarise(Tests_sum = sum(Tests), avg_pos = mean(Test_pos_rate))

Pos_Rate$Date <-  as.Date(Pos_Rate$Date)


# Rolling mean

rolling_mean_7 <- rollmean(Pos_Rate$avg_pos, k = 7, fill = NA)


Chart2 <- Pos_Rate %>% 
  plot_ly(x = ~Date, y = ~avg_pos, name = "Positivity Rate", type = "scatter", mode = "lines",
          line = list(width = 4),
          hoverinfo = "text", text = ~paste(
    "Date:", Date, "<br>",
    "Tests:", Tests_sum, "<br>",
    "Pos Rate (%):", avg_pos
  ))

Chart2 <- Chart2 %>% add_trace(y = ~rolling_mean_7, name = "Rolling mean (7 days)", mode = "lines")
Chart2 <- Chart2 %>% layout(title = "Lab Positivity Rate",
                            xaxis = list(title = "Date", tickangle = 45),
                            yaxis = list(title = "Positivity Rate (%)"))

Chart2



```



### Cumulative lab testing by age and gender

```{r eval = TRUE}

testing_get <- GET("https://data.edmonton.ca/resource/ypc6-7cu6.json?$limit=10000")
testing <- fromJSON(rawToChar(testing_get$content))

testing$date <- as_date(testing$date)
testing$age <- as.factor(testing$age)
testing <- testing %>% mutate_at(c(
                                   "count_female",
                                   "percent_female",
                                   "count_male",
                                   "percent_male",
                                   "count_unknown",
                                   "percent_unknown",
                                   "count_all",
                                   "percent_all"), as.numeric)

testing <- rename(testing, Female = count_female, Male = count_male, Unknown = count_unknown)

testing_agegender_cum <- testing %>% group_by(age) %>% select(date, age, Female, Male, Unknown) %>% filter(age %notin% "All" & date == max(date))


testing_agegender_cum <- melt(testing_agegender_cum)
testing_agegender_cum <- testing_agegender_cum %>% filter(variable %notin% "date")


testing_agegender_cum_plot <- ggplot(testing_agegender_cum, aes(x = age, y= value, fill = variable)) + 
  geom_col(show.legend = FALSE) +
  facet_wrap(~variable) +
  theme_classic()+
  scale_y_continuous(expand = expansion(mult = c(0,.1))) +
  scale_x_discrete(guide = guide_axis(check.overlap = 1)) +
  xlab("Age Group") +
  ylab("Count") +
  ggtitle("Number of COVID-19 lab tests in Alberta by age group facetted by gender") +
  theme(axis.title.x = element_text(margin = margin(10,0,0,0))) + 
  theme(legend.position = "none") + 
  theme(axis.text.x = element_text(angle = 45, hjust= 1)) + 
  theme(axis.title.x = element_blank())
  

ggplotly(testing_agegender_cum_plot)



```

Row
----------------------------------------------------

### Positivity Rate by zone

```{r eval = TRUE}

Pos_Rate_Zone <- Hospital %>% filter(Location %notin% "Unknown" & Location %notin% "Alberta") %>% group_by(Date, Location) %>% summarise(Tests_sum = sum(Tests), avg_pos = mean(Test_pos_rate))

Pos_Rate_Zone<- Pos_Rate_Zone %>% group_by(Location) %>% mutate(rollmean = round(rollapply(avg_pos, 7, mean, fill =NA),2))


Pos_Rate_Zone_plot <- ggplot(Pos_Rate_Zone) +
  geom_line(aes(x = Date, y = avg_pos)) +
  geom_line(aes(x = Date, y=rollmean, color =  Location))+
  facet_grid(Location~.) +
  labs(title = "Positivity Rate in Alberta by Zone", xlab = "Date", y = "Percent Positive") +
  theme_bw() +
  theme(legend.position = "none") +
  theme(strip.text.y = element_text(size = 7)) +
  theme(panel.grid.major.x = element_blank())



ggplotly(Pos_Rate_Zone_plot, dynamicTicks = TRUE) %>% layout(hovermode = "X")



```
Forecasting
============================================================

```{r}
print("Under Construction")
```


```{r eval = FALSE}
library(fpp2)

COVID_19_TS <- COVID19 %>% group_by(Date_reported) %>% count()
COVID_19_TS <- ts(COVID_19_TS[,2], start = 2020-03-06)

autoplot(COVID_19_TS)
frequency(COVID_19_TS) #Daily
ggAcf(COVID_19_TS)

Box.test(COVID_19_TS, lag =1, type = "Ljung" )

autoplot(naive(COVID_19_TS, h= 10))

COVID_19_TS %>% naive() %>% checkresiduals()

train <- subset(COVID_19_TS, end = 500)
naive_covid <- naive(train, h = 54)
mean_covid <- meanf(train, h = 54)
ses_covid <- ses(train, h = 54)
#Find the smallest RMSE which equates to greater accuracy .. naive vs ses
accuracy(naive_covid, COVID_19_TS)
accuracy(mean_covid, COVID_19_TS)
accuracy(ses_covid, COVID_19_TS)

# Time series cross-validation
tscv <- tsCV(COVID_19_TS, forecastfunction = ses, h = 54)
mse <- colMeans(tscv^2, na.rm = TRUE)
data.frame(h = 1:54, MSE = mse) %>% ggplot(aes(x = h , y = MSE)) + geom_point()


fit <- auto.arima(COVID_19_TS)
checkresiduals(fit)

autoplot(COVID_19_TS)
BoxCox.lambda(COVID_19_TS)
COVID_19_TS %>% BoxCox(lambda = 0.1983581) %>% checkresiduals()


```





Worldwide
===================================================
```{r eval = TRUE}

World_Coordinates <- read_csv("World_Coordinates.csv")

#CSV data are obtained from https://data.humdata.org/dataset/novel-coronavirus-2019-ncov-cases
#Dashboard will be updated weekly
#Recovery data discontinued on Aug 5, 2021

ts_confirmed_global_raw <- read_csv("time_series_covid19_confirmed_global.csv")
ts_confirmed_global <- as.data.frame(ts_confirmed_global_raw)
ts_confirmed_global <- ts_confirmed_global %>% select(1:4, tail(names(.),2))
ts_confirmed_global <- ts_confirmed_global %>% mutate(Diff = ts_confirmed_global[,6] - ts_confirmed_global[,5])
colnames(ts_confirmed_global) <- c("Province_State", "Country_Region", "Lat", "Long", "Confirmed_yesterday", "Confirmed_today", "Diff")

#-----------------------------------------------------------------------------------------------------
ts_deaths_global_raw <- read_csv("time_series_covid19_deaths_global.csv")
ts_deaths_global <- as.data.frame(ts_deaths_global_raw)
ts_deaths_global <- ts_deaths_global %>% select(1:4, tail(names(.),2))
ts_deaths_global <- ts_deaths_global %>% mutate(Diff = ts_deaths_global[,6] - ts_deaths_global[,5])
colnames(ts_deaths_global) <- c("Province_State", "Country_Region", "Lat", "Long", "Deaths_Yesterday", "Deaths_today", "Diff")

#-----------------------------------------------------------------------------------------------------

```


Row {data-width = 200}
-------------------------------------------------------

### Update
```{r World Date}
valueBox(value = "4 October 2021" , 
         caption = "Last Updated", 
         icon = "fas fa-clock",
         color = "purple"
        )
```


### Confirmed Cases
```{r World Cases}
World_Cases_Diff <- prettyNum(sum(ts_confirmed_global$Diff), big.mark = ",")


valueBox(value = prettyNum(sum(ts_confirmed_global$Confirmed_today), big.mark = ","), 
         caption = paste0("Confirmed Cases", "<br>", "New Cases: +", World_Cases_Diff),
         icon = "fas fa-chart-bar", 
         color = "teal"
         )
```

### Deaths
```{r World Deaths}
World_Deaths_Diff <- prettyNum(sum(ts_deaths_global$Diff), big.mark = ",")


valueBox(value = prettyNum(sum(ts_deaths_global$Deaths_today), big.mark = ","),
         caption = paste0("Deaths", "<br>", "New Deaths: +", World_Deaths_Diff),
         color = "red", 
         icon = "fas fa-skull-crossbones"
         )
```

### Vaccinations
```{r World Vaccinations}

World_covid_data_owid_raw <- read_csv("owid-covid-data.csv")

World_covid_data_owid <- World_covid_data_owid_raw %>% filter(date == max(date)) %>% select(1:6, 8:9,18,20,26:27,32,35:37, 47)

world_covid_vacc_yesterday <- World_covid_data_owid_raw %>% filter(date == max(date)-1) %>% select(1:4, total_vaccinations)
world_covid_vacc_today <- World_covid_data_owid_raw %>% filter(date == max(date)) %>% select(1:4, total_vaccinations)

world_covid_vacc <- world_covid_vacc_yesterday %>% 
  left_join(world_covid_vacc_today, by = "iso_code",suffix = c("Yesterday", "Today")) %>% 
  mutate(Diff = total_vaccinationsToday - total_vaccinationsYesterday) %>% 
  select(1:5,8:10)




valueBox(value = prettyNum(sum(world_covid_vacc$total_vaccinationsToday, na.rm = TRUE), big.mark = ","),
         caption = paste0("Total Vaccinations, ", "<br>", "Change: ", prettyNum(sum(world_covid_vacc$Diff, na.rm = TRUE), big.mark =
                                                                                  ",")),
         color = "fuchsia",
         icon = "fas fa-syringe")

```




Row {data-height = 800}
-------------------------------------------------------

### World leaflet
```{r World leaflet, eval = TRUE, fig.height= 10, fig.width= 10}

leaflet(World_Coordinates) %>% 
  
  setView(2,5,3) %>%
  
  addProviderTiles("Esri.NatGeoWorldMap",options = providerTileOptions(noWrap = TRUE), group = "Light")%>%
  addCircleMarkers(radius = 5,
                   color = "red",
                   popup = ~paste0("<b>Date: 4 October 2021 </b>", "<br>", 
                                   "<b>Country/Region: </b>",World_Coordinates$Country_Region, "<br>",
                                 "<b>Province/State: </b>", World_Coordinates$Province_State, "<br>",
                                 "<b>Confirmed Cases: </b>",prettyNum(ts_confirmed_global$Confirmed_today, big.mark = ",") , "<br>",
                                 "<b>Deaths: </b>", prettyNum(ts_deaths_global$Deaths_today, big.mark = ","))) %>%
  
  addEasyButton(easyButton(icon = "fa-globe", 
                           title = "Reset Zoom",
                           onClick = JS("function(btn,map){ map.setZoom(3); }"))) %>%
  
  addEasyButton(easyButton(icon="fa-crosshairs", 
                           title = "Locate Me", 
                           onClick = JS("function(btn, map) {map.locate({setView: true});}"))) %>%
  
  addMeasure(position = "bottomleft",
             primaryLengthUnit = "kilometers",
             primaryAreaUnit = "sqmeters",
             activeColor = "#8d60b5",
             completedColor = "#c280e8")


  
 


```

### World Choropleth

```{r eval = FALSE, fig.height= 10, fig.width = 10}


ts_world_COVID19_confirmed_narrow_raw <- read.csv("time_series_covid19_confirmed_global_narrow.csv")
ts_world_COVID19_confirmed_narrow <- as.data.frame(ts_world_COVID19_confirmed_narrow_raw)



world_choropleth <- as.data.frame(World_covid_data_owid_raw)
world_choropleth <- world_choropleth %>% select(1:4, new_cases_per_million)


ts_world_COVID19_confirmed_narrow <- ts_world_COVID19_confirmed_narrow %>% left_join(world_choropleth, by = c("ISO_3166" = "iso_code"))



plot_geo(world_choropleth, locationmode = 'country names') %>%
  add_trace(
    z = ~new_cases_per_million,
    locations = ~iso_code,
    color = ~new_cases_per_million,
    colors = "Oranges",
    frame = ~date
  )
         
         



#plot_geo(ts_world_COVID19_confirmed_narrow,
#         locations = ~ISO_3166,
#         z = ~Value,
#         frame = ~Date,
#         color = ~Value)


```







About
===========================================================


Welcome to the unofficial Alberta COVID-19 Dashboard. This dashboard was created using R programming software 
and the data was obtained from the City of Edmonton open dataset webpage using JSON and geoJSON functionality. 



Purpose
--------------------------------------------------------------

#### Purpose
The purpose of this dashboard is to create an easy to read visualization of the COVID-19 information in Alberta. There are a few disclaimers regarding the data: 

- Plots may not be up to date as data is dependent on when the original dataset is updated by the City of Edmonton. To check if the data is current, hover over the most recent data point to check, otherwise, certain plots may tell you in the caption or header

- Data are pulled from various sources. Some sources are frequently updated, others are not. 

- Plots may not be 100% accurate. Calculations of certain plots require data wrangling and mathematical calculations. Plots are cross referenced to the plots created by the City of Edmonton and AHS for accuracy


- The efficiency of the code may not be optimal and run times may be longer than what is needed to formulate the plots. This project
was used a learning opportunity to explore the various R packages and to hone coding skills


Future
--------------------------------------------------------------

#### Future

The dashboard will be continuously updated and new plots will be formed over time. Currently, I am working on:

- An animated choropleth map of COVID-19 cases over time in Alberta
- A separate page to view world wide COVID-19 spread
- Cumulative bar plot of COVID-19 vaccinations over time in Alberta
- Cumulative bar plot of COVID-19 vaccinations grouped by age over time in Alberta
- Allow users to select a date on the Introduction page


Data
--------------------------------------------------------------

#### Raw Data
Raw data used to create the dashboard can be found here:

- [COVID-19 Alberta Zone Cases](https://data.edmonton.ca/Community-Services/COVID-19-in-Alberta-Cases-by-Zone/jmcu-tz8y)

- [COVID-19 Alberta Cases by Geography](https://data.edmonton.ca/Community-Services/COVID-19-in-Alberta-Current-cases-by-local-geograp/ix8f-s9xp)

- [COVID-19 Alberta Vaccine Progress](https://data.edmonton.ca/Externally-Sourced-Datasets/COVID-19-in-Alberta-Vaccination-Progress-by-Zone/d43f-8ikp)

- [COVID-19 Alberta Vaccination Progress by Geography](https://data.edmonton.ca/Externally-Sourced-Datasets/COVID-19-in-Alberta-Vaccination-Progress-by-Local-/tgzq-jumt)

- [COVID-19 Alberta Day by Day](https://data.edmonton.ca/Community-Services/COVID-19-in-Alberta-Day-by-day/gxqm-z6fa)

- [COVID-19 Alberta Case History by Geography](https://data.edmonton.ca/Externally-Sourced-Datasets/COVID-19-in-Alberta-Case-History-by-Municipality-a/rrjc-ssaw)




Contact
--------------------------------------------------------------

#### Contact

If there is an issue regarding the data or you have suggestions for better written code or suggestions for certain types of plots you would like to see, please email me at stevendang619@outlook.com


Thank you for your feedback and enjoy the dashboard.





```{r}
#For git Run:

#git init
#git pull
#git push
#git add *
#git commit -m "...."
#git push -u origin main
```







